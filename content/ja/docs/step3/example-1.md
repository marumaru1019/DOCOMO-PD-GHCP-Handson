---
title: "問題1: テストカバレッジの向上"
categories: [実践演習, GitHub Copilot]
tags: [test, coverage, jest, testing-library]
weight: 1
---

## 問題

テスト実装で学んだ技法を活用して、GHCP-TodoAppプロジェクトのテストカバレッジを向上させてください。

### 🎯 ゴール

テストカバレッジを以下の基準まで向上させること：

- **行カバレッジ（Lines）**: 90%以上
- **関数カバレッジ（Functions）**: 85%以上
- **分岐カバレッジ（Branches）**: 80%以上
- **文カバレッジ（Statements）**: 90%以上

> **💡 カバレッジの種類について**
>
> - **行カバレッジ（Lines）**: 実行されたコードの行数の割合。コードの物理的な行がテストで実行されているかを測定
> - **関数カバレッジ（Functions）**: 呼び出された関数やメソッドの割合。定義されている関数のうち、テストで実際に呼び出されているものの比率
> - **分岐カバレッジ（Branches）**: if文やswitch文などの条件分岐で、すべての分岐パターンがテストされているかの割合
> - **文カバレッジ（Statements）**: 実行された文（ステートメント）の割合。セミコロンで区切られる個々の実行単位の実行率


### ✅ ゴールの確認方法

以下のコマンドを実行して、すべてのカバレッジ基準をクリアできればゴール達成です：

```bash
npm test -- --coverage --coverageThreshold='{"global":{"branches":80,"functions":85,"lines":90,"statements":90}}'
```

**成功の判定基準：**
- テストが正常終了（失敗例のような表示がされない）
- coverage/lcov-report/index.html を確認して、以下の数値を達成
  - 行カバレッジ（Lines）: 90%以上
  - 関数カバレッジ（Functions）: 85%以上
  - 分岐カバレッジ（Branches）: 80%以上
  - 文カバレッジ（Statements）: 90%以上
![カバレッジレポート](../images/coverage-report.png)

**失敗例：**
```
Jest: "global" coverage threshold for branches (80%) not met: 77.86%
```
このようなメッセージが表示された場合は、該当項目のカバレッジが不足しています。

失敗の際は、下記のようにカバレッジレポートの下にカバレッジ不足のメッセージが表示されます：
```bash

-------------------------|---------|----------|---------|---------|------------------------------
File                     | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s
-------------------------|---------|----------|---------|---------|------------------------------
All files                |    92.2 |    77.86 |   86.88 |   93.13 |
 components/list         |   90.81 |    75.45 |   85.96 |    91.9 |
  DeleteConfirmModal.tsx |     100 |      100 |     100 |     100 |
  TodoApp.tsx            |   92.07 |     72.5 |   81.81 |   94.44 | 53,97-99,175
  TodoFilter.tsx         |     100 |      100 |     100 |     100 |
  TodoInput.tsx          |     100 |      100 |     100 |     100 |
  TodoItem.tsx           |      82 |       68 |   84.61 |      82 | 41-42,54-56,68-70,84,114,180
 utils                   |     100 |      100 |     100 |     100 |
  dateUtils.ts           |     100 |      100 |     100 |     100 |
  index.ts               |     100 |      100 |     100 |     100 |
-------------------------|---------|----------|---------|---------|------------------------------
Jest: "global" coverage threshold for branches (80%) not met: 77.86% ← ここで分岐カバレッジが不足していることがわかる

Test Suites: 6 passed, 6 total
Tests:       71 passed, 71 total
Snapshots:   0 total
Time:        4.109 s
Ran all test suites.
```

### 📋 進め方

> **💡 注意**
> 以下に示す進め方は**一例**です。本ハンズオンを通して学んだGitHub Copilotの活用方法や効果的な指示の出し方を活かして、**あなた自身の方法で実装まで進めてください**。
>
> **推奨アプローチ：**
> - これまでの演習で身につけた `#codebase`、`#fetch` などの活用パターンを応用する
> - 段階的に実装を進める際の指示の粒度や順序を自分で考える
> - エラーが発生した場合のデバッグ指示の出し方を工夫する
> - 要件を満たしているかの確認方法を自分なりに設計する
>
> 下記の手順は参考として活用し、より効果的だと思う方法があれば積極的に試してみてください。

#### Step 1: 現状分析

1. **現在のカバレッジ状況を把握**
   ```bash
   # カバレッジレポート生成
   npm test -- --coverage

   # HTMLレポートでの詳細確認
   open coverage/lcov-report/index.html
   ```

2. **カバレッジレポートの分析**
   - どのファイルがテストされていないかを確認
   - HTMLレポートで詳細な不足箇所を把握

#### Step 2: Copilotによる課題特定

1. **ターミナル結果をCopilotに分析依頼**
   ```bash
   # カバレッジレポートを実行
   npm test -- --coverage

   # 結果をターミナルで選択（ドラッグで範囲選択）
   # その後、以下のプロンプトでCopilotチャットに依頼
   ```

2. **具体的な分析プロンプト**
   ```markdown
   #terminalSelection
   このカバレッジレポートを分析し、以下の観点で報告してください：

   1. テストが存在しないコンポーネント一覧
   2. カバレッジが低い関数/メソッド（80%未満）
   3. テストされていない分岐処理
   4. 優先度の高いテスト追加箇所

   ゴール達成（Lines 90%、Functions 85%、Branches 80%、Statements 90%）のための具体的なテスト実装計画を提案してください。
   ```

#### Step 3: 計画的テスト実装

1. **最優先: 未テストファイルの基本テスト作成**
   ```markdown
   /generate-test: componentName=[未テストコンポーネント名]

   以下の要件でテストを生成してください：
   - 基本レンダリングテスト
   - Props変更時の挙動テスト
   - ユーザーインタラクションテスト
   - エラーハンドリングテスト
   ```

2. **次優先: カバレッジ不足箇所の補強**
   ```markdown
   #codebase [カバレッジが低いファイル名]のテストを分析し、
   不足している以下のテストケースを追加してください：
   - 条件分岐のテスト
   - エラーハンドリングのテスト
   - エッジケースのテスト
   ```

3. **進捗確認**
   ```bash
   npm test -- --coverage
   ```

#### Step 4: 最終確認

```bash
# 最終的なカバレッジ確認
npm test -- --coverage --coverageThreshold='{"global":{"branches":80,"functions":85,"lines":90,"statements":90}}'
```

**✅ 成功時**: "Test Suites: X passed" のメッセージのみ表示
**❌ 失敗時**: "coverage threshold for XXX not met" エラーが表示される場合はStep 3に戻る

---

## ヒント

### 💡 カバレッジ分析のアプローチ

**1. 現状把握**
```bash
# カバレッジレポート生成
npm test -- --coverage

# HTMLレポートでの詳細確認
open coverage/lcov-report/index.html
```

**2. GitHub Copilotでの効率的な分析**

まず、カバレッジレポートの結果をターミナルで選択してからCopilotに分析を依頼します：

```bash
# カバレッジレポートを実行
npm test -- --coverage

# 結果をターミナルで選択（ドラッグで範囲選択）
# その後、以下のプロンプトでCopilotチャットに依頼
```

```markdown
#terminalSelection
このカバレッジレポートを分析し、以下の観点で報告してください：

1. テストが存在しないコンポーネント一覧
2. カバレッジが低い関数/メソッド（80%未満）
3. テストされていない分岐処理
4. 優先度の高いテスト追加箇所

ゴール達成（Lines 90%、Functions 85%、Branches 80%、Statements 90%）のための具体的なテスト実装計画を提案してください。
```

### 🛠️ 効率的なテスト実装手法

**1. プロンプトファイルの活用**
```markdown
/generate-test: componentName=[未テストコンポーネント名]

以下の要件でテストを生成してください：
- 基本レンダリングテスト
- Props変更時の挙動テスト
- ユーザーインタラクションテスト
- エラーハンドリングテスト
```

**2. カバレッジ不足箇所の特定プロンプト**
```markdown
このコンポーネントのテストカバレッジが不足している理由を分析し、以下を含むテストケースを追加してください：

1. 未実行の条件分岐
2. エラーケースの処理
3. 異なるProps組み合わせでの動作
4. ライフサイクルメソッドの検証

カバレッジ向上に効果的なテストケースを優先的に実装してください。
```

この問題を通じて、実務で求められる高いテストカバレッジを達成する技術と、GitHub Copilotを活用した効率的なテスト実装手法を身につけることができます。
